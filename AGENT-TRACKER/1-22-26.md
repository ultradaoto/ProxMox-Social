# Agent Tracker - January 22, 2026

## Session Summary

This document captures the work completed on the Self-Healing Workflow System, user requirements, and planned next steps.

---

## What Was Built

### 1. Self-Healing Core System (`/Ubu-Cont/src/self_healing/`)

**Files Created:**
- `__init__.py` - Package exports
- `config.py` - Configuration with 30% similarity threshold, API key loading from config.json
- `vision_locator.py` - AI-powered element finding using Qwen 2.5 Vision via OpenRouter
- `workflow_updater.py` - Updates workflow JSON files with backup/rollback support
- `healer.py` - Main orchestrator that detects failures and coordinates healing
- `events.py` - Thread-safe event store for real-time monitoring with live logs
- `manual_heal.py` - Manual healing trigger for testing via web UI

**Key Features:**
- Reads screenshots from existing `/dev/shm/vnc_latest.png` (no duplicate VNC stream)
- Uses existing click execution logic (just updates coordinates in JSON)
- Creates backups before modifying workflow files
- Tracks all healing events with timestamps, coordinates, AI reasoning

### 2. Workflow Caching Fix

**Modified:** `/Ubu-Cont/src/workflows/json_workflow.py`
- Now reloads JSON fresh on every `execute()` call
- Saving workflow in web UI immediately takes effect on next run

### 3. Orchestrator Workflow Reload

**Modified:** `/Ubu-Cont/src/orchestrator.py`
- Added `reload_workflows()` method
- Added `reload_workflow(platform)` for single platform reload

### 4. Validation System Enhancement

**Modified:** `/Ubu-Cont/src/validation/validator.py`
- Added `failed_clicks` list to `WorkflowValidationResult`
- Includes screenshot data and baselines for self-healing integration

### 5. Healing Dashboard (`/heal/`)

**Modified:** `/Ubu-Cont/src/vnc_stream_server.py`
- Added "Heal" link to main page header (orange, next to Runs)
- Created comprehensive `/heal/` dashboard page

**Dashboard Features:**
- **System Status**: Shows if healing is Active/Disabled/Unavailable
- **Statistics**: Total attempts, success rate, successful/failed counts
- **Configuration Display**: Similarity threshold (30%), max attempts (3), AI confidence (70%)
- **Manual Heal Section**:
  - Workflow dropdown (instagram, facebook, linkedin, skool)
  - **Scan** button - Analyzes current screen vs baselines
  - **Heal All** button - Triggers AI healing for broken clicks
- **Live Logs Panel**: Real-time terminal-style log output showing AI thinking/reasoning
- **Healing Events Panel**: History of all healing attempts with details

**API Endpoints Added:**
- `GET /heal/api/status` - Full status with stats and config
- `GET /heal/api/events` - Recent healing events
- `GET /heal/api/logs?since=<id>` - Live log polling
- `GET /heal/api/workflows` - List available workflows
- `POST /heal/api/scan/<workflow>` - Scan workflow for broken clicks
- `POST /heal/api/heal/<workflow>` - Trigger healing for all broken clicks
- `POST /heal/api/heal-click/<workflow>/<index>` - Heal single click
- `POST /heal/api/toggle` - Enable/disable healing
- `POST /heal/api/clear` - Clear logs and history

---

## Current State (As of Session End)

### Scan Results for Instagram (2:04:40 PM):
```
Click #0: 97.7% - OK (OPEN URL on OSP)
Click #1: 97.9% - OK (Create Post button)
Click #2: 31.9% - OK (Post option in menu) <-- BORDERLINE
Click #3: 15.3% - NEEDS HEALING (Select from computer) <-- FIRST BROKEN
Click #4: 97.9% - OK (COPY FILE LOCATION)
Click #5: -4.8% - NEEDS HEALING
Click #6: -5.2% - NEEDS HEALING
Click #7: -1.5% - NEEDS HEALING
Click #8: 14.7% - NEEDS HEALING
Click #9: 0.0% - NEEDS HEALING
Click #10: 0.0% - NEEDS HEALING
Click #11: 96.2% - OK (COPY BODY)
Click #12: -19.8% - NEEDS HEALING
Click #13: 0.0% - NEEDS HEALING
Click #14: 97.5% - OK (SUCCESS button)
Click #15: 17.6% - NEEDS HEALING

Total: 10 clicks need healing
```

### Key Insight from User:
> "The first click that broke is just that Instagram moved the button down the page by 50 pixels... if clicking the 'Post' button properly is resolved, then everything else down the chain will start to work again. We don't need the system to rebuild every single step."

This is a **cascade failure** - fixing click #3 will likely fix clicks #5-10 and #12-13 because they all depend on the UI state after click #3.

---

## User Requirements

### Completed:
1. ✅ Visual validation system with 100x100 screenshots and crosshairs
2. ✅ SQLite database for baselines, runs, screenshots
3. ✅ Similarity comparison (SSIM-based)
4. ✅ Click index tracking (separate from action index)
5. ✅ Web UI for baseline recording and run comparison
6. ✅ Self-healing system with AI vision (Qwen 2.5)
7. ✅ Workflow caching fix (reload on each execute)
8. ✅ Healing dashboard with manual trigger
9. ✅ Live logs for monitoring AI thinking
10. ✅ Platform-agnostic design (works for any workflow)

### Pending/Requested:

#### 1. Smart Cascade Healing
**Requirement:** Instead of healing all 10 broken clicks, heal only the FIRST broken click, then verify by running a test workflow. If 3 consecutive clicks match, stop healing.

**Implementation Needed:**
- After healing click #3, send `Ctrl+W` to close current tab
- Run through workflow from start, comparing each click to baseline
- If 3 consecutive matches achieved, declare healing complete
- If still failing, heal next broken click and repeat

#### 2. Test Workflow Mode
**Requirement:** A special workflow run mode for healing verification that:
- Uses test content (not real posts)
- Compares clicks to baselines during execution
- Does NOT actually submit/post content
- Reports success/failure based on similarity matches

#### 3. Test Content in OSP
**Requirement:** The healing agent needs content to test with. Need to create a "TEST post" that can be loaded into the OSP (On-Screen Panel) for healing verification.

**Considerations:**
- Test content should be clearly marked (e.g., "[TEST] Do not post")
- System should abort before final "Share/Post" click
- Or use a draft mode if platform supports it

---

## Recommended Next Steps

### Priority 1: Smart Cascade Healing
```python
# Pseudocode for cascade healing
def heal_with_verification(workflow_name):
    broken_clicks = scan_workflow(workflow_name)  # Get list sorted by index
    
    for click in broken_clicks:
        # Heal this click
        result = heal_click(click)
        if not result.success:
            continue
        
        # Close any open dialogs/tabs
        send_keys('ctrl+w')
        wait(2)
        
        # Run verification workflow
        consecutive_matches = 0
        for test_click in workflow.clicks:
            similarity = compare_to_baseline(test_click)
            if similarity > 0.70:
                consecutive_matches += 1
                if consecutive_matches >= 3:
                    log("3 consecutive matches - healing complete!")
                    return SUCCESS
            else:
                consecutive_matches = 0
                break  # Stop at first failure
        
        # If we got here, need to heal more clicks
        continue
    
    return PARTIAL_SUCCESS
```

### Priority 2: Test Content System
1. Create API endpoint or OSP feature to load test content
2. Add "test mode" flag to workflow execution
3. Modify workflow to skip final post/share action in test mode
4. Store test content in database or config

### Priority 3: Abort Before Post
```python
# In json_workflow.py, add test mode check
async def _execute_click(self, action, index):
    if self.test_mode and action.get('is_final_submit'):
        self.log("TEST MODE: Skipping final submit")
        return StepResult(SUCCESS, "Skipped in test mode")
    # ... normal execution
```

### Priority 4: UI Enhancements
1. Add "Heal First Broken" button (not just "Heal All")
2. Show cascade analysis (which clicks depend on which)
3. Add verification progress indicator
4. Show before/after screenshots for healed clicks

---

## File Locations Reference

### Self-Healing System
```
/Ubu-Cont/src/self_healing/
├── __init__.py
├── config.py          # SIMILARITY_FAILURE_THRESHOLD = 0.30
├── events.py          # HealingEventStore, live logs
├── healer.py          # WorkflowHealer class
├── manual_heal.py     # ManualHealer for web UI
├── vision_locator.py  # VisionLocator (Qwen 2.5 Vision)
└── workflow_updater.py # WorkflowUpdater with backups
```

### Modified Files
```
/Ubu-Cont/src/workflows/json_workflow.py  # Self-healing integration
/Ubu-Cont/src/validation/validator.py     # failed_clicks list
/Ubu-Cont/src/orchestrator.py             # reload_workflows()
/Ubu-Cont/src/vnc_stream_server.py        # /heal/ dashboard
```

### Workflow Backups
```
/Ubu-Cont/recordings/backups/  # Timestamped backups before healing
```

---

## Configuration

### Self-Healing Thresholds (in config.py)
- `SIMILARITY_FAILURE_THRESHOLD = 0.30` (30% - below this triggers healing)
- `MAX_HEALING_ATTEMPTS = 3` (retries per click)
- `CONFIDENCE_THRESHOLD = 0.70` (AI must be 70%+ confident)

### API Key
- Loaded from `/Ubu-Cont/config.json` under `vision.api_key`
- Falls back to `OPENROUTER_API_KEY` environment variable

---

## Testing Instructions

### To Test Manual Healing:
1. Open two browser tabs:
   - Tab 1: `http://localhost:5555/` (Live Control)
   - Tab 2: `http://localhost:5555/heal/` (Healing Dashboard)

2. On Heal page:
   - Select workflow from dropdown
   - Click **Scan** to see similarity scores
   - Watch **Live Logs** for detailed output
   - Click **Heal All** to trigger AI healing

3. On Live Control:
   - Watch the VNC stream to see current state
   - Verify clicks are hitting correct targets after healing

### To Verify Fix Applied:
```bash
# Check workflow JSON was updated
cat /home/ultra/proxmox-social/Ubu-Cont/recordings/instagram_default.json | jq '.actions[X]'

# Check backup was created
ls -la /home/ultra/proxmox-social/Ubu-Cont/recordings/backups/
```

---

## Notes for Next Session

1. **Instagram's UI Change**: The "Post" button moved ~50 pixels down. This is click #2 or #3 in the workflow. Fixing this should cascade-fix most other failures.

2. **Negative Similarity Scores**: Some clicks show -4.8%, -19.8% etc. This indicates the current screen is very different from baseline (likely wrong dialog/page is open due to earlier click failure).

3. **OSP Clicks Still Work**: Clicks #0, #4, #11, #14 (all OSP panel clicks) still match because OSP doesn't change when Instagram updates their UI.

4. **Test Content Needed**: Before running a full healing verification, need a way to load test content into OSP so the workflow has something to "post" (but won't actually post).

---

*Document created: January 22, 2026*
*Session ended with healing system functional and ready for cascade healing implementation*
